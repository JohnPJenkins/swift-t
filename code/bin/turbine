#!/bin/bash

# Turbine wrapper script

# Sets Turbine location, obtains configuration, launches

# Usage:
# turbine [-l] -n <processes> <program.tcl>

# Defaults:
MPIEXEC_PROCS=1
MPIEXEC_L=

while getopts ":ln:" opt
do
  case $opt in
    l)
      MPIEXEC_L="-l"
      ;;
    n)
      MPIEXEC_PROCS=${OPTARG}
      ;;
    \?)
      echo "turbine: unknown option: ${OPTARG}"
      exit 1
      ;;
  esac
done

shift $(( OPTIND-1 ))
PROGRAM=$1

MPIEXEC_OPTS=
MPIEXEC_OPTS+="${MPIEXEC_L} "
MPIEXEC_OPTS+="-n ${MPIEXEC_PROCS}"

TURBINE_BIN=$( dirname $0 )
if [[ -z ${TURBINE_HOME} ]]
then
  TURBINE_HOME=$( cd ${TURBINE_BIN}/.. ; /bin/pwd )
fi

source ${TURBINE_HOME}/scripts/turbine-config.sh

# Allow user to insert valgrind
mpiexec ${MPIEXEC_OPTS} ${VALGRIND} ${TCLSH} ${PROGRAM}
# Exit code returned by shell script
